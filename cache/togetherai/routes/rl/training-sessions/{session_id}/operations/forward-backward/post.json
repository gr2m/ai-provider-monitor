{
  "description": "Submits a forward-backward pass operation that will asynchronously compute gradients via backpropagation.",
  "operationId": "forwardBackward",
  "parameters": [
    {
      "in": "path",
      "name": "session_id",
      "required": true,
      "schema": {
        "description": "Training session ID",
        "type": "string"
      }
    }
  ],
  "requestBody": {
    "content": {
      "application/json": {
        "schema": {
          "$ref": "#/components/schemas/RL.ForwardBackwardBody"
        }
      }
    },
    "required": true
  },
  "responses": {
    "200": {
      "content": {
        "application/json": {
          "schema": {
            "$ref": "#/components/schemas/RL.ForwardBackwardOperation"
          }
        }
      },
      "description": ""
    },
    "default": {
      "content": {
        "application/json": {
          "schema": {
            "$ref": "#/components/schemas/RpcStatus"
          }
        }
      },
      "description": "An unexpected error response."
    }
  },
  "summary": "Forward-backward pass",
  "tags": [
    "RL"
  ],
  "components": {
    "schemas": {
      "RL.ForwardBackwardBody": {
        "properties": {
          "loss": {
            "$ref": "#/components/schemas/RL.LossConfig",
            "description": "Loss function configuration"
          },
          "samples": {
            "description": "Batch of training samples to process",
            "items": {
              "$ref": "#/components/schemas/RL.TrainingSample",
              "type": "object"
            },
            "type": "array"
          }
        },
        "required": [
          "samples",
          "loss"
        ],
        "type": "object"
      },
      "RL.ForwardBackwardOperation": {
        "properties": {
          "error": {
            "$ref": "#/components/schemas/RL.TrainingOperationError"
          },
          "id": {
            "description": "Operation ID",
            "example": "550e8400-e29b-41d4-a716-446655440000",
            "type": "string"
          },
          "output": {
            "$ref": "#/components/schemas/RL.ForwardBackwardResult"
          },
          "status": {
            "$ref": "#/components/schemas/RL.TrainingOperationStatus",
            "description": "Operation status",
            "example": "TRAINING_OPERATION_STATUS_PENDING"
          }
        },
        "type": "object"
      },
      "RpcStatus": {
        "properties": {
          "code": {
            "format": "int32",
            "type": "integer"
          },
          "details": {
            "items": {
              "$ref": "#/components/schemas/ProtobufAny",
              "type": "object"
            },
            "type": "array"
          },
          "message": {
            "type": "string"
          }
        },
        "type": "object"
      },
      "RL.LossConfig": {
        "properties": {
          "cross_entropy_params": {
            "$ref": "#/components/schemas/RL.CrossEntropyLossParams"
          },
          "grpo_params": {
            "$ref": "#/components/schemas/RL.GRPOLossParams"
          },
          "type": {
            "$ref": "#/components/schemas/RL.LossType",
            "description": "Type of loss function to use",
            "example": "LOSS_TYPE_GRPO"
          }
        },
        "required": [
          "type"
        ],
        "type": "object"
      },
      "RL.TrainingSample": {
        "properties": {
          "loss_inputs": {
            "$ref": "#/components/schemas/RL.LossInputs",
            "description": "Loss function inputs"
          },
          "model_input": {
            "$ref": "#/components/schemas/RL.ModelInput",
            "description": "Model input"
          }
        },
        "required": [
          "model_input",
          "loss_inputs"
        ],
        "type": "object"
      },
      "RL.TrainingOperationError": {
        "properties": {
          "code": {
            "$ref": "#/components/schemas/RL.TrainingOperationErrorCode",
            "description": "Application error code",
            "example": "TRAINING_OPERATION_ERROR_CODE_TIMEOUT"
          },
          "message": {
            "description": "Human-readable error message",
            "example": "Operation timed out",
            "type": "string"
          }
        },
        "type": "object"
      },
      "RL.ForwardBackwardResult": {
        "properties": {
          "loss": {
            "description": "Loss value",
            "example": 2.345,
            "type": "number"
          },
          "metrics": {
            "additionalProperties": {
              "format": "double",
              "type": "number"
            },
            "description": "Loss-specific metrics (e.g., KL divergence, clip fraction for GRPO)",
            "type": "object"
          }
        },
        "type": "object"
      },
      "RL.TrainingOperationStatus": {
        "default": "TRAINING_OPERATION_STATUS_UNSPECIFIED",
        "enum": [
          "TRAINING_OPERATION_STATUS_UNSPECIFIED",
          "TRAINING_OPERATION_STATUS_PENDING",
          "TRAINING_OPERATION_STATUS_RUNNING",
          "TRAINING_OPERATION_STATUS_COMPLETED",
          "TRAINING_OPERATION_STATUS_FAILED"
        ],
        "type": "string"
      },
      "ProtobufAny": {
        "additionalProperties": {},
        "properties": {
          "@type": {
            "type": "string"
          }
        },
        "type": "object"
      },
      "RL.CrossEntropyLossParams": {
        "description": "Cross-entropy loss parameters (currently empty).",
        "properties": {},
        "type": "object"
      },
      "RL.GRPOLossParams": {
        "properties": {
          "agg_type": {
            "$ref": "#/components/schemas/RL.GRPOLossAggregationType",
            "default": "GRPO_LOSS_AGGREGATION_TYPE_FIXED_HORIZON",
            "description": "Aggregation type for loss computation",
            "example": "GRPO_LOSS_AGGREGATION_TYPE_FIXED_HORIZON"
          },
          "beta": {
            "default": "0.0",
            "description": "KL penalty coefficient",
            "example": 0.1,
            "format": "float",
            "type": "number"
          },
          "clip_high": {
            "default": "0.28",
            "description": "Upper clip bound for importance ratio",
            "example": 0.28,
            "format": "float",
            "type": "number"
          },
          "clip_low": {
            "default": "0.2",
            "description": "Lower clip bound for importance ratio",
            "example": 0.2,
            "format": "float",
            "type": "number"
          }
        },
        "type": "object"
      },
      "RL.LossType": {
        "default": "LOSS_TYPE_UNSPECIFIED",
        "enum": [
          "LOSS_TYPE_UNSPECIFIED",
          "LOSS_TYPE_CROSS_ENTROPY",
          "LOSS_TYPE_GRPO"
        ],
        "type": "string"
      },
      "RL.LossInputs": {
        "properties": {
          "grpo_inputs": {
            "$ref": "#/components/schemas/RL.GRPOLossInputs"
          },
          "loss_mask": {
            "$ref": "#/components/schemas/RL.LossMask",
            "description": "Per-token loss mask (1=compute loss, 0=ignore)"
          },
          "target_tokens": {
            "$ref": "#/components/schemas/RL.LossTargetTokens",
            "description": "Target tokens for loss computation (optional, defaults to shifted input_ids)"
          }
        },
        "type": "object"
      },
      "RL.ModelInput": {
        "properties": {
          "chunks": {
            "description": "Input chunks for the model",
            "items": {
              "$ref": "#/components/schemas/RL.InputChunk",
              "type": "object"
            },
            "type": "array"
          }
        },
        "required": [
          "chunks"
        ],
        "type": "object"
      },
      "RL.TrainingOperationErrorCode": {
        "default": "TRAINING_OPERATION_ERROR_CODE_UNSPECIFIED",
        "enum": [
          "TRAINING_OPERATION_ERROR_CODE_UNSPECIFIED",
          "TRAINING_OPERATION_ERROR_CODE_RESOURCE_EXHAUSTED",
          "TRAINING_OPERATION_ERROR_CODE_TIMEOUT",
          "TRAINING_OPERATION_ERROR_CODE_INTERNAL_ERROR",
          "TRAINING_OPERATION_ERROR_CODE_SESSION_NOT_ACTIVE"
        ],
        "type": "string"
      },
      "RL.GRPOLossAggregationType": {
        "default": "GRPO_LOSS_AGGREGATION_TYPE_UNSPECIFIED",
        "enum": [
          "GRPO_LOSS_AGGREGATION_TYPE_UNSPECIFIED",
          "GRPO_LOSS_AGGREGATION_TYPE_FIXED_HORIZON",
          "GRPO_LOSS_AGGREGATION_TYPE_PER_TOKEN"
        ],
        "type": "string"
      },
      "RL.GRPOLossInputs": {
        "properties": {
          "advantages": {
            "$ref": "#/components/schemas/RL.LossAdvantages",
            "description": "Per-token advantages for GRPO"
          },
          "generator_logprobs": {
            "$ref": "#/components/schemas/RL.LossLogprobs",
            "description": "Generator log probabilities for GRPO"
          },
          "reference_logprobs": {
            "$ref": "#/components/schemas/RL.LossLogprobs",
            "description": "Reference model log probabilities (required if beta > 0)"
          }
        },
        "required": [
          "advantages",
          "generator_logprobs"
        ],
        "type": "object"
      },
      "RL.LossMask": {
        "description": "Per-token loss mask (1=compute loss, 0=ignore)",
        "properties": {
          "data": {
            "description": "Integer array of per-token mask values (0s and 1s)",
            "example": [
              0,
              0,
              1
            ],
            "items": {
              "format": "int64",
              "type": "string"
            },
            "type": "array"
          },
          "dtype": {
            "$ref": "#/components/schemas/RL.DType",
            "description": "Data type of the integer array (must be D_TYPE_INT64)",
            "example": "D_TYPE_INT64"
          }
        },
        "required": [
          "data"
        ],
        "type": "object"
      },
      "RL.LossTargetTokens": {
        "properties": {
          "data": {
            "description": "Integer array of target tokens",
            "example": [
              123,
              456,
              789
            ],
            "items": {
              "format": "int64",
              "type": "string"
            },
            "type": "array"
          },
          "dtype": {
            "$ref": "#/components/schemas/RL.DType",
            "description": "Data type of the integer array",
            "example": "D_TYPE_INT64"
          }
        },
        "required": [
          "data"
        ],
        "type": "object"
      },
      "RL.InputChunk": {
        "properties": {
          "encoded_text": {
            "$ref": "#/components/schemas/RL.EncodedText"
          }
        },
        "type": "object"
      },
      "RL.LossAdvantages": {
        "properties": {
          "data": {
            "description": "Float array of per-token advantages",
            "example": [
              0.5,
              0.5
            ],
            "items": {
              "format": "float",
              "type": "number"
            },
            "type": "array"
          },
          "dtype": {
            "$ref": "#/components/schemas/RL.DType",
            "description": "Data type of the float array (D_TYPE_FLOAT32 or D_TYPE_BFLOAT16)",
            "example": "D_TYPE_FLOAT32"
          }
        },
        "required": [
          "data"
        ],
        "type": "object"
      },
      "RL.LossLogprobs": {
        "properties": {
          "data": {
            "description": "Float array of per-token log probabilities",
            "example": [
              -1.2,
              -0.8
            ],
            "items": {
              "format": "float",
              "type": "number"
            },
            "type": "array"
          },
          "dtype": {
            "$ref": "#/components/schemas/RL.DType",
            "description": "Data type of the float array (D_TYPE_FLOAT32 or D_TYPE_BFLOAT16)",
            "example": "D_TYPE_FLOAT32"
          }
        },
        "required": [
          "data"
        ],
        "type": "object"
      },
      "RL.DType": {
        "default": "D_TYPE_UNSPECIFIED",
        "enum": [
          "D_TYPE_UNSPECIFIED",
          "D_TYPE_INT64",
          "D_TYPE_FLOAT32",
          "D_TYPE_BFLOAT16"
        ],
        "type": "string"
      },
      "RL.EncodedText": {
        "properties": {
          "tokens": {
            "description": "Pre-tokenized text input",
            "example": [
              123,
              456,
              789
            ],
            "items": {
              "format": "int64",
              "type": "string"
            },
            "type": "array"
          }
        },
        "type": "object"
      }
    }
  }
}
